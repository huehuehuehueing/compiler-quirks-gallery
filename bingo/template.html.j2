<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compiler Optimization Bingo &mdash; Card {{ card.id }}</title>
<style>
/* ── Reset & Base ─────────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --dg:#00693e; --dg-light:#1a7a52; --dg-dark:#004d2e;
  --easy:#e8f5e9; --medium:#fff3e0; --hard:#fce4ec;
  --flipped:#e3f2fd; --bingo-gold:#ffd600;
  --sq-border:2px solid var(--dg);
  --radius:6px;
}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
     background:#f5f5f5;color:#222;padding:1rem}

/* ── Header / Scoreboard ──────────────────────────────────── */
header{max-width:820px;margin:0 auto 1rem;text-align:center}
h1{color:var(--dg);font-size:1.6rem;margin-bottom:.3rem}
.card-meta{font-size:.8rem;color:#666;margin-bottom:.6rem}
.scoreboard{display:flex;justify-content:center;gap:1.5rem;
            flex-wrap:wrap;font-size:.95rem}
.scoreboard span{background:#fff;border:1px solid #ddd;border-radius:4px;
                  padding:.25rem .6rem}
.scoreboard strong{color:var(--dg)}

/* ── Mode toggle ──────────────────────────────────────────── */
.modes{margin:.6rem 0}
.modes button{padding:.3rem .8rem;border:1px solid var(--dg);
              background:#fff;color:var(--dg);border-radius:4px;
              cursor:pointer;font-size:.8rem;margin:0 .2rem}
.modes button.active{background:var(--dg);color:#fff}

/* ── 5x5 Grid ─────────────────────────────────────────────── */
.bingo-grid{display:grid;grid-template-columns:repeat(5,1fr);
            gap:4px;max-width:820px;margin:0 auto 1rem}

.sq{position:relative;border:var(--sq-border);border-radius:var(--radius);
    min-height:120px;cursor:pointer;overflow:hidden;
    display:flex;align-items:center;justify-content:center;
    transition:background .25s,box-shadow .25s;padding:6px}

.sq.d1{background:var(--easy)}
.sq.d2{background:var(--medium)}
.sq.d3{background:var(--hard)}

.sq .badge{position:absolute;top:3px;right:5px;font-size:.65rem;font-weight:700;opacity:.7}
.sq.d1 .badge{color:#2e7d32}
.sq.d2 .badge{color:#ef6c00}
.sq.d3 .badge{color:#c62828}

.sq .cat{position:absolute;bottom:3px;left:5px;font-size:.55rem;
         text-transform:uppercase;letter-spacing:.5px;opacity:.5}

.sq .front,.sq .back{width:100%;text-align:center}
.sq .front{font-size:.78rem;line-height:1.35}
.sq .back{display:none;font-size:.78rem;line-height:1.35}
.sq .back .answer{font-weight:700;color:var(--dg-dark)}
.sq .back .hint{margin-top:6px;font-size:.65rem;color:#888;font-style:italic}

/* Flipped state */
.sq.flipped{background:var(--flipped);border-color:var(--dg-light)}
.sq.flipped .front{display:none}
.sq.flipped .back{display:block}

/* Gave-up state (quiz mode) */
.sq.gave-up{background:#ccc;border-color:#999}
.sq.gave-up .front{display:none}
.sq.gave-up .back{display:block}
.sq.gave-up .back .answer{color:#666}

/* Bingo highlight */
.sq.bingo-line{box-shadow:inset 0 0 0 3px var(--bingo-gold),0 0 8px rgba(255,214,0,.5)}

/* FREE square */
.sq.free{background:var(--dg);color:#fff;cursor:default;font-weight:700;font-size:1rem;
         letter-spacing:2px}

/* Self-study hint visibility */
body[data-mode="selfstudy"] .sq .cat{opacity:.8;font-weight:600}

/* ── Classroom Modal ─────────────────────────────────────── */
.classroom-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;
              background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
.classroom-overlay.visible{display:flex}
.classroom-modal{background:#fff;border-radius:8px;width:90%;max-width:480px;
            box-shadow:0 8px 32px rgba(0,0,0,.3);overflow:hidden}
.classroom-modal-header{background:var(--dg);color:#fff;padding:.8rem 1rem;font-weight:700;
                   font-size:.95rem}
.classroom-modal-body{padding:1rem}
.classroom-modal-body .prompt-text{font-size:.85rem;line-height:1.4;margin-bottom:.6rem;
                                    color:#666;font-style:italic}
.classroom-modal-body .answer-text{font-size:1rem;line-height:1.4;font-weight:700;
                                    color:var(--dg-dark);margin-bottom:.8rem}
.classroom-modal-body .hint-text{font-size:.75rem;color:#888;font-style:italic;margin-bottom:.8rem}
.classroom-modal-actions{display:flex;gap:.5rem}
.classroom-modal-actions button{flex:1;padding:.5rem .6rem;border:1px solid #ddd;
                           border-radius:4px;cursor:pointer;font-size:.9rem;
                           font-weight:700;transition:background .15s}
.classroom-modal-actions .btn-correct{background:var(--dg);color:#fff;border-color:var(--dg)}
.classroom-modal-actions .btn-correct:hover{background:var(--dg-dark)}
.classroom-modal-actions .btn-wrong{background:#fff;color:#c62828;border-color:#c62828}
.classroom-modal-actions .btn-wrong:hover{background:#fce4ec}

/* Wrong state (classroom mode) */
.sq.wrong{background:#ccc;border-color:#999}
.sq.wrong .front{display:none}
.sq.wrong .back{display:block}
.sq.wrong .back .answer{color:#666}

/* ── Quiz Modal ──────────────────────────────────────────── */
.quiz-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;
              background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
.quiz-overlay.visible{display:flex}
.quiz-modal{background:#fff;border-radius:8px;width:90%;max-width:480px;
            box-shadow:0 8px 32px rgba(0,0,0,.3);overflow:hidden}
.quiz-modal-header{background:var(--dg);color:#fff;padding:.8rem 1rem;font-weight:700;
                   font-size:.95rem}
.quiz-modal-body{padding:1rem}
.quiz-modal-body .prompt-text{font-size:.9rem;line-height:1.4;margin-bottom:.8rem;
                               color:#333}
.quiz-modal-body input[type="text"]{width:100%;padding:.5rem .6rem;font-size:.9rem;
                                     border:2px solid #ddd;border-radius:4px;
                                     outline:none;transition:border-color .2s}
.quiz-modal-body input[type="text"]:focus{border-color:var(--dg)}
.quiz-modal-body .feedback{font-size:.85rem;margin-top:.5rem;min-height:1.2em}
.quiz-modal-body .feedback.wrong{color:#c62828;font-weight:600}
.quiz-modal-body .feedback.correct{color:var(--dg);font-weight:600}
.quiz-modal-actions{display:flex;gap:.5rem;margin-top:.8rem}
.quiz-modal-actions button{flex:1;padding:.45rem .6rem;border:1px solid #ddd;
                           border-radius:4px;cursor:pointer;font-size:.85rem;
                           font-weight:600;transition:background .15s}
.quiz-modal-actions .btn-submit{background:var(--dg);color:#fff;border-color:var(--dg)}
.quiz-modal-actions .btn-submit:hover{background:var(--dg-dark)}
.quiz-modal-actions .btn-giveup{background:#fff;color:#666}
.quiz-modal-actions .btn-giveup:hover{background:#f5f5f5}

/* ── Footer ───────────────────────────────────────────────── */
footer{max-width:820px;margin:1rem auto 0;text-align:center;font-size:.75rem;color:#888}
footer button{padding:.3rem .8rem;border:1px solid #ccc;background:#fff;
              border-radius:4px;cursor:pointer;margin:0 .3rem .5rem;font-size:.8rem}
footer button:hover{background:#eee}

/* ── Print ────────────────────────────────────────────────── */
@media print{
  .no-print{display:none!important}
  body{background:#fff;padding:0}
  .bingo-grid{gap:2px;max-width:100%}
  .sq{min-height:100px;border-width:1px}
  .sq.flipped .back .answer{color:#333}
  .quiz-overlay{display:none!important}
  .classroom-overlay{display:none!important}
}
</style>
</head>
<body data-mode="classroom">

<header>
  <h1>Compiler Optimization Bingo</h1>
  <div class="card-meta">Card <strong>{{ card.id }}</strong> &middot; Seed {{ card.seed }}</div>
  <div class="modes no-print">
    <button class="active" onclick="setMode('classroom')">Classroom</button>
    <button onclick="setMode('selfstudy')">Self-Study</button>
    <button onclick="setMode('quiz')">Quiz</button>
  </div>
  <div class="scoreboard">
    <span id="pts-label">Points: <strong id="pts">0</strong> / {{ card.max_points }}</span>
    <span>Bingos: <strong id="bingos">0</strong></span>
    <span>Flipped: <strong id="flipped">0</strong> / 24</span>
    <span id="correct-label" style="display:none">Correct: <strong id="correct">0</strong></span>
  </div>
</header>

<div class="bingo-grid">
{% for i in range(25) %}
{% if i == 12 %}
  <div class="sq free" data-i="12">FREE</div>
{% else %}
{% set s = card.squares[i] %}
  <div class="sq d{{ s.difficulty }}" data-i="{{ i }}" data-p="{{ s.difficulty }}" onclick="flip(this)">
    <span class="badge">{{ "\u2605" * s.difficulty }}</span>
    <span class="cat">{{ s.category }}</span>
    <div class="front">{{ s.prompt }}</div>
    <div class="back">
      <div class="answer">{{ s.answer }}</div>
{% if s.hint %}
      <div class="hint">{{ s.hint }}</div>
{% endif %}
    </div>
  </div>
{% endif %}
{% endfor %}
</div>

<!-- Classroom answer modal -->
<div class="classroom-overlay" id="classroom-overlay">
  <div class="classroom-modal">
    <div class="classroom-modal-header">Did you get it right?</div>
    <div class="classroom-modal-body">
      <div class="prompt-text" id="classroom-prompt"></div>
      <div class="answer-text" id="classroom-answer"></div>
      <div class="hint-text" id="classroom-hint"></div>
      <div class="classroom-modal-actions">
        <button class="btn-correct" onclick="classroomCorrect()">Correct</button>
        <button class="btn-wrong" onclick="classroomWrong()">Wrong</button>
      </div>
    </div>
  </div>
</div>

<!-- Quiz answer modal -->
<div class="quiz-overlay" id="quiz-overlay">
  <div class="quiz-modal">
    <div class="quiz-modal-header">Answer the Challenge</div>
    <div class="quiz-modal-body">
      <div class="prompt-text" id="quiz-prompt"></div>
      <input type="text" id="quiz-input" placeholder="Type your answer..." autocomplete="off">
      <div class="feedback" id="quiz-feedback"></div>
      <div class="quiz-modal-actions">
        <button class="btn-submit" id="quiz-submit" onclick="submitQuiz()">Submit</button>
        <button class="btn-giveup" id="quiz-giveup" onclick="giveUpQuiz()">Give Up</button>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="no-print">
    <button onclick="resetCard()">Reset</button>
    <button onclick="window.print()">Print</button>
  </div>
  <p>Compiler Optimization Gallery &middot; COSC-69.16 Dartmouth College</p>
</footer>

<script>
(function(){
  var fl=new Set([12]),pts=0,correctCount=0,bonusPerLine=5;
  var gaveUpSet=new Set(),wrongSet=new Set();
  var quizTarget=null;
  var classroomTarget=null;

  var ACCEPT={ {% for i in range(25) %}{% if i != 12 %}{% set s = card.squares[i] %}{{i}}:{{ s.accept | tojson }},{% endif %}{% endfor %} };

  var LINES=[
    [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
    [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
    [0,6,12,18,24],[4,8,12,16,20]
  ];

  function isQuizMode(){return document.body.dataset.mode==="quiz"}
  function isClassroomMode(){return document.body.dataset.mode==="classroom"}

  function checkAnswer(input,squareIndex){
    var val=input.trim().toLowerCase();
    if(!val)return false;
    return ACCEPT[squareIndex].some(function(kw){
      return val.indexOf(kw.toLowerCase())!==-1;
    });
  }

  window.flip=function(el){
    var i=+el.dataset.i;
    if(fl.has(i))return;
    if(isQuizMode()){
      openQuizModal(el);
      return;
    }
    if(isClassroomMode()){
      openClassroomModal(el);
      return;
    }
    fl.add(i);
    el.classList.add("flipped");
    pts+=+el.dataset.p;
    update();
  };

  function openQuizModal(el){
    quizTarget=el;
    var prompt=el.querySelector(".front").textContent;
    document.getElementById("quiz-prompt").textContent=prompt;
    document.getElementById("quiz-input").value="";
    document.getElementById("quiz-feedback").textContent="";
    document.getElementById("quiz-feedback").className="feedback";
    document.getElementById("quiz-overlay").classList.add("visible");
    setTimeout(function(){document.getElementById("quiz-input").focus()},50);
  }

  function closeQuizModal(){
    document.getElementById("quiz-overlay").classList.remove("visible");
    quizTarget=null;
  }

  window.submitQuiz=function(){
    if(!quizTarget)return;
    var input=document.getElementById("quiz-input").value;
    var i=+quizTarget.dataset.i;
    if(checkAnswer(input,i)){
      var fb=document.getElementById("quiz-feedback");
      fb.textContent="Correct!";
      fb.className="feedback correct";
      fl.add(i);
      quizTarget.classList.add("flipped");
      pts+=+quizTarget.dataset.p;
      correctCount++;
      update();
      setTimeout(closeQuizModal,600);
    }else{
      var fb=document.getElementById("quiz-feedback");
      fb.textContent="Incorrect \u2014 try again or give up.";
      fb.className="feedback wrong";
      document.getElementById("quiz-input").value="";
      document.getElementById("quiz-input").focus();
    }
  };

  window.giveUpQuiz=function(){
    if(!quizTarget)return;
    var i=+quizTarget.dataset.i;
    fl.add(i);
    gaveUpSet.add(i);
    quizTarget.classList.add("gave-up");
    /* no points awarded */
    update();
    closeQuizModal();
  };

  /* ── Classroom modal ─────────────────────────────────────── */
  function openClassroomModal(el){
    classroomTarget=el;
    var prompt=el.querySelector(".front").textContent;
    var answer=el.querySelector(".back .answer").textContent;
    var hintEl=el.querySelector(".back .hint");
    document.getElementById("classroom-prompt").textContent=prompt;
    document.getElementById("classroom-answer").textContent=answer;
    var hintOut=document.getElementById("classroom-hint");
    hintOut.textContent=hintEl?hintEl.textContent:"";
    hintOut.style.display=hintEl?"":"none";
    document.getElementById("classroom-overlay").classList.add("visible");
  }

  function closeClassroomModal(){
    document.getElementById("classroom-overlay").classList.remove("visible");
    classroomTarget=null;
  }

  window.classroomCorrect=function(){
    if(!classroomTarget)return;
    var i=+classroomTarget.dataset.i;
    fl.add(i);
    classroomTarget.classList.add("flipped");
    pts+=+classroomTarget.dataset.p;
    update();
    closeClassroomModal();
  };

  window.classroomWrong=function(){
    if(!classroomTarget)return;
    var i=+classroomTarget.dataset.i;
    fl.add(i);
    wrongSet.add(i);
    classroomTarget.classList.add("wrong");
    /* no points awarded */
    update();
    closeClassroomModal();
  };

  /* Close modals on Escape; submit on Enter */
  document.addEventListener("keydown",function(e){
    if(e.key==="Escape"){
      if(document.getElementById("quiz-overlay").classList.contains("visible"))
        closeQuizModal();
      if(document.getElementById("classroom-overlay").classList.contains("visible"))
        closeClassroomModal();
    }
    if(e.key==="Enter"&&document.getElementById("quiz-overlay").classList.contains("visible")){
      e.preventDefault();
      submitQuiz();
    }
  });

  function update(){
    var ptsLabel=document.getElementById("pts-label");
    if(isQuizMode()){
      ptsLabel.innerHTML="Score: <strong id=\"pts\">"+String(pts+bingoBonus())+"</strong> / {{ card.max_points }}";
      document.getElementById("correct-label").style.display="";
      document.getElementById("correct").textContent=correctCount;
    }else{
      ptsLabel.innerHTML="Points: <strong id=\"pts\">"+String(pts+bingoBonus())+"</strong> / {{ card.max_points }}";
      document.getElementById("correct-label").style.display="none";
    }
    document.getElementById("flipped").textContent=fl.size-1;
    document.getElementById("bingos").textContent=countBingos();
  }

  function countBingos(){
    var n=0;
    document.querySelectorAll(".sq.bingo-line").forEach(function(e){e.classList.remove("bingo-line")});
    LINES.forEach(function(line){
      if(line.every(function(idx){return fl.has(idx)})){
        n++;
        line.forEach(function(idx){
          document.querySelector('[data-i="'+idx+'"]').classList.add("bingo-line");
        });
      }
    });
    return n;
  }

  function bingoBonus(){return countBingos()*bonusPerLine}

  window.setMode=function(m){
    document.body.dataset.mode=m;
    document.querySelectorAll(".modes button").forEach(function(b){
      b.classList.toggle("active",b.textContent.toLowerCase().replace("-","")===m);
    });
    update();
  };

  window.resetCard=function(){
    fl=new Set([12]);pts=0;correctCount=0;gaveUpSet=new Set();wrongSet=new Set();
    document.querySelectorAll(".sq:not(.free)").forEach(function(el){
      el.classList.remove("flipped","bingo-line","gave-up","wrong");
    });
    document.querySelectorAll(".sq.free").forEach(function(el){
      el.classList.remove("bingo-line");
    });
    update();
  };
})();
</script>
</body>
</html>
